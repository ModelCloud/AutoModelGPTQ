name: Run tests 2

on:
  push:
  repository_dispatch:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted
    container:
      image: pytorch/pytorch:2.3.1-cuda12.1-cudnn8-devel
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          pip install parameterized protobuf

      - name: Install local package
        run: |
          pip install -vvv --no-build-isolation -e .

      - name: Run tests
        run: |
          cd tests
          tests=$(ls *.py -1 | xargs -n 1 basename)
          passed=0
          failed=0
          for test in "${tests[@]}"; do
              echo "Running $test..."
              python -m unittest "$test"
              if [ $? -eq 0 ]; then
                  echo "$test passed."
                  passed=$((passed + 1))
              else
                  echo "$test failed."
                  failed=$((failed + 1))
              fi
          done
          echo "----------------------"
          echo "Total tests run: ${#tests[@]}"
          echo "Passed: $passed"
          echo "Failed: $failed"
          if [ $failed -eq 0 ]; then
              echo "All tests passed."
              exit 0
          else
              echo "Some tests failed."
              exit 1
          fi
